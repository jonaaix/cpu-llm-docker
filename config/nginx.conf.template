events {
    worker_connections 1024;
}

http {
    # Basic Optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    types_hash_max_size 2048;
    server_tokens off;

    # Timeouts for Long-Running LLM Generation (10 Minutes)
    keepalive_timeout 600s;
    client_body_timeout 600s;
    client_header_timeout 600s;

    server {
        listen 80;
        server_name _;

        location / {
            # -------------------------------------------------------
            # SECURITY: API KEY VALIDATION
            # -------------------------------------------------------
            if ($http_authorization != "Bearer ${API_SECRET_KEY}") {
                return 401 '{"error": "Unauthorized: Invalid API Key"}';
            }

            # -------------------------------------------------------
            # PROXY: OLLAMA BACKEND
            # -------------------------------------------------------
            proxy_pass http://llm-api:11434;

            # CRITICAL: Disable buffering for Streaming Responses
            proxy_buffering off;

            # Proxy Headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            # Extended Timeouts
            proxy_read_timeout 600s;
            proxy_connect_timeout 600s;
            proxy_send_timeout 600s;
        }
    }
}
